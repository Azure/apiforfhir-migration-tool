# Appendix
## Migration tool limitations

Please take note of the following limitations of the migration tool before choosing to utilize the tool:

-   Since you are copying data to a new Azure Health Data Service FHIR server, you will have a new FHIR server URL and will need to manually point your applications to a new FHIR URL.
-   The migration tool only copies FHIR resources. It will not copy over your FHIR server configurations, you will need to manually set those configurations again in your new FHIR server. See below for more information on setting configurations.
-   If you wish to keep your Azure API for FHIR live during the migration process, the migration tool only copies new, edited, and soft deleted FHIR resources that are updated or added during the migration process. If a FHIR resource is hard-deleted from the source Azure API for FHIR server during the migration (after the initial migration), you will need to manually keep track of deletes that happen during the migration, and manually delete them from your new server post-migration.

## Additional Azure API for FHIR Prep to do specific to Migration Tool

If you are planning to use the migration tool, please take note of these additional steps to take when preparing your Azure API for FHIR server for migration:

-   The tool consumes resources, so if you want it to run as fast as it can, cancel all non-business critical jobs (like reindexing or large imports) if you can.
-   If your current Azure API for FHIR server has autoscaling turned on, \$export on a large amount of data may boost your RU and increase your cost. If you’d like to change from autoscale to fixed, please file a CSS support ticket to turn autoscaling off.
-   If you don’t already have a storage account set up for exports, choose a storage account to export to in Azure Portal under the “Export” tab for the Azure API for FHIR resource.

### Eventing

-   The migration tool will put all the exports from Azure API for FHIR into one container called “Migration” in the storage account that is specified for export. If you currently are using eventing for your Azure API for FHIR service and have a filter on EventGrid that tracks your \$export storage account, be sure to exclude the “Migration” container so that it does not interfere with your existing eventing set up.

## Configurations to set in your new Azure Health Data Services FHIR Server

As you set up your new Azure Health Data Services FHIR Service server, you may want to use the same configurations that you had in Azure API for FHIR for your new Azure Health Data Services FHIR Service server. If so, here are some recommended configurations to note. Some configurations can be set up during the Azure Health Data Services FHIR Service deployment process ([Deploy a FHIR service within Azure Health Data Services \| Microsoft Learn)](https://learn.microsoft.com/en-us/azure/healthcare-apis/fhir/fhir-portal-quickstart) . Others can be set up post-migration in Azure Portal.

In your Azure API for FHIR server on Azure Portal, go to the “Properties” tab. Here you will see a list of your curent Azure API for FHIR configurations. The following table details when and where to set up the corresponding same configurations in Azure Health Data Services FHIR Service, if you’d like to set up the same configurations.

| Configuration                                            | When to configure                                                                                                          | Where to configure                                                                                                                                                                                                    | Notes                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      |
|----------------------------------------------------------|----------------------------------------------------------------------------------------------------------------------------|-----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|
| Location                                                 | Pre-migration                                                                                                              | During FHIR server deployment                                                                                                                                                                                         |                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            |
| FHIR version                                             | Pre-migration                                                                                                              | During FHIR server deployment                                                                                                                                                                                         |                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            |
| Private Link                                             | Pre-migration Please follow instructions here (insert link for Private Link instructions – TODO Xoriant) for Private Link. | Please follow instructions here (insert link for Private Link instructions – TODO Xoriant) for Private Link.                                                                                                          |                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            |
| Authentication: Authority, Audience, Allowed Object ID’s | Pre-migration                                                                                                              | During FHIR server deployment                                                                                                                                                                                         |                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            |
| RBAC and Custom Authority                                | Post-migration                                                                                                             | In Azure Portal under “Access control (IAM)” tab                                                                                                                                                                      |                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            |
| SMART on FHIR                                            | Either pre- or post-migration                                                                                              | Pre: During FHIR server deployment Post: In Azure Portal  Please refer to [SMART on FHIR - Azure Health Data Services \| Microsoft Learn](https://learn.microsoft.com/en-us/azure/healthcare-apis/fhir/smart-on-fhir) | Note: SMART on FHIR proxy is being deprecated. You will need to use the new SMARt on FHIR capability. Please see [SMART on FHIR - Azure Health Data Services \| Microsoft Learn](https://learn.microsoft.com/en-us/azure/healthcare-apis/fhir/smart-on-fhir) for more information.                                                                                                                                                                                                                                                                         |
| Provisioned throughout (RU/s)                            | N/A, this is only applicable to Azure API for FHIR                                                                         |                                                                                                                                                                                                                       |                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            |
| Customer Managed Key                                     | Either pre- or post-migration                                 |            [Configure customer-managed keys for the FHIR service](https://learn.microsoft.com/en-us/azure/healthcare-apis/fhir/configure-customer-managed-keys)                                                                                                                                                                                                           |                                                                                                                                                                                                                                                                                                                                                                                                                                                                  |
| Tags                                                     | Either pre- or post-migration                                                                                              | Pre: During FHIR server deployment Post: In “Tags” tab                                                                                                                                                                |                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            |
| Versioning Policy                                        | Pre-migration                                                                                                              | During FHIR server deployment                                                                                                                                                                                         | Note: $export in Azure API for FHIR now supports history and soft deletes. More info on the query parameters [here](https://learn.microsoft.com/en-us/azure/healthcare-apis/azure-api-for-fhir/export-data#query-parameters).                                                                                                                                                                                                                                                                                                                                                                                                                                                         |
| CORS                                                     | Post-migration                                                                                                             | In Azure Portal under “CORS” tab                                                                                                                                                                                      |                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            |
| Managed Identity                                         | Post-migration                                                                                                             | In Azure Portal under “Identity” tab                                                                                                                                                                                  |                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            |
| Storage account for export                               | Post-migration                                                                                                             | In Azure Portal in the “Export” tab                                                                                                                                                                                   |                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            |
| ACR Container                                            | Post-migration                                                                                                             | In Azure Portal under “Artifacts” tab                                                                                                                                                                                 |                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            |
| Profiles                                                 | Pre-migration                                                                                                             | Re-upload profiles into the new FHIR server before starting the migration                                                                                                                                                                              |                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            |
| Custom search parameters                                 | Post-migration (see note)                                                                                                  |                                                                                                                                                                                                                       | Note: Custom search parameters that are in the source FHIR server prior to the migration will be automatically brought over to Azure Health Data Services FHIR Service with the migration tool; this is the first step of the migration tool that runs. Data will be properly indexed after that as it gets migrated into Azure Health Data Services FHIR Service, as long as you use [incremental mode $import](https://learn.microsoft.com/en-us/azure/healthcare-apis/fhir/import-data#incremental-mode). If you add any custom search parameters after the migration tool has started, it will not be brought over. You will need to query Azure API for FHIR for the new search parameters as a bundle, POST those to Azure Health Data Services FHIR Service, then run a reindex for them to work.                                                                 |
| Client Registration                                      | Post-migration                                                                                                             | In Azure Portal under “Access control (IAM)” tab                                                                                                                                                                      |                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            |
| Eventing                                                 | Post-migration                                                                                                             | Please see Eventing overview here [What are Events? - Azure Health Data Services \| Microsoft Learn](https://learn.microsoft.com/en-us/azure/healthcare-apis/events/events-overview)                                  | During migration, eventing in Azure API for FHIR can continue. Please make sure to see our note on Eventing above (link to above eventing note) Make sure eventing in Azure Health Data Services FHIR Service server is turned off during migration. You can turn on eventing in Azure Health Data Services FHIR Service only after the cutover and migration has finished. Please refer here to learn more about [eventing](https://learn.microsoft.com/en-us/azure/healthcare-apis/events/events-overview) in Azure Health Data Services FHIR Service.   |
| Sync Agent for Dataverse                                 |                                                                                                                            |                                                                                                                                                                                                                       | Sync Agent is being deprecated. If you were using Sync Agent to connect to Dataverse, please see [Overview of Data integration toolkit \| Microsoft Learn](https://learn.microsoft.com/en-us/dynamics365/industry/healthcare/data-integration-toolkit-overview?toc=%2Findustry%2Fhealthcare%2Ftoc.json&bc=%2Findustry%2Fbreadcrumb%2Ftoc.json)                                                                                                                                                                                                             |
| Extensions                                 |         No need to configure                                                                                                                   |            Extensions will be pulled in automatically along with the resources during  migration.                                                                                                                                                                                                           |      Note: If you have custom extensions that are not contained within a resource, you will need to migrate them manually.                                                                                                                                                                                                       |



## Common Errors in Migration Tool

| Category                                             | Error Codes/Scenarios                                                                                                          | Resolution                                                                                                                                                                                                                                   | 
|------------------------------------------------------|----------------------------------------------------------------------------------------------------------------------------|-----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|
|Migration Tool Error                                  |  Export and Import Configuration Failure                                                                                                              | Confirm that the storage account is correctly specified. It is mandatory that the same storage account is used for both export and import processes in Migration Tool.                                                                                                                                                                                         |                                                                                                               
|Migration Tool Error                                  |  Azure API for FHIR and Azure Health Data Services FHIR service should be in same subscription                                                                                                              | Move both the server to the correct subscription<br>• Navigate to the Azure portal.<br>• Locate the Azure API for FHIR / Azure Health Data Services FHIR service.<br>• In the left-hand menu, click on "Change Subscription".<br>• Select the correct subscription and follow the prompts to move the resource.                                                                                                                                                                                         |
|Migration Tool Error                                  | Permisssion issue in deployment of migration tool                                        | • User should have required access rights, such as Owner or Contributor in subscriptions.<br>• User should have privilege to assign roles.                                                                               |  
|FHIR Server Error                                     | Status code: 401                                          | **Check Authentication** :<br>Ensure that the client is properly authenticated with the FHIR server.<br>Verify that the authentication credentials (e.g., API keys, tokens) are correct.                                                                               |
|FHIR Server Error                                     | Status code: 413                                          | **Reduce Request Payload Size** :<br>• Navigate to the Function App <br>• In the Function App's menu, go to "Overview". <br>• Click on the "Stop" button to halt the Function App's operation, ensuring that no import or export operation is currently in progress. Please verify the status of import/export operations in the export table of storage account.<br>• In the Function App menu, find and click on "Environment Variable" under the "Settings" section.<br>• Look for the 'AZURE_ExportChunkTime' environment variable and reduce the value of AZURE_ExportChunkTime<br>• Click on the "Save" button to apply the changes.<br>• Navigate back to the Function App's "Overview" and Click on the "Start" button to restart the Function App with the updated environment variable.                                                                               |
|FHIR Server Error                                     | Status code: 429                                          | Increase the throttling limit on FHIR server                                                                               |
|FHIR Server Error                                     | Status code: 423                                          | If the initialImportMode property of the Azure Health Data Services FHIR service is enabled, this error may occur. <br>                     To resolve this issue disable the initialImportMode property of the Azure Health Data Services FHIR service.                                                                               |
|Troubleshooting Section for FHIR Server Errors                                     |                                          | https://learn.microsoft.com/en-us/azure/healthcare-apis/fhir/import-data#troubleshooting                                                                               |
