{
    "$schema": "https://schema.management.azure.com/schemas/2018-05-01/subscriptionDeploymentTemplate.json#",
    "contentVersion": "1.0.0.0",
    "parameters": {
        "prefix": {
            "type": "string",
            "minLength": 1,
            "maxLength": 6,
            "metadata": {
                "description": "Prefix for Migration tool resources."
            }
        },
        "location": {
            "type": "string",
            "minLength": 1,
            "metadata": {
                "description": "Primary location for all resources"
            }
        },
        "fhirServiceName": {
            "type": "string",
            "metadata": {
                "description": "Name of the FHIR Service to import resources into. Format is \"workspace/fhirService\"."
            }
        },
        "apiForFhirName": {
            "type": "string",
            "metadata": {
                "description": "Name of the API for FHIR to export resources from."
            }
        },
        "storageAccount": {
            "type": "string",
            "metadata": {
                "description": "Name of the storage account."
            }
        },
        "newStorageAccount": {
            "type": "string",
            "metadata": {
                "description": "Name of the new storage account to be created."
            }
        }
    },
    "functions": [],
    "variables": {
        "uniqueResourceIdentifier": "[toLower(substring(uniqueString(resourceGroup().id, parameters('prefix')), 0, 4))]",
        "prefixNameClean": "[format('{0}{1}', replace(parameters('prefix'), '-', ''), variables('uniqueResourceIdentifier'))]",
        "prefixNameCleanShort": "[if(greater(length(variables('prefixNameClean')), 16), substring(variables('prefixNameClean'), 0, 8), variables('prefixNameClean'))]",
        "appTags": {"app-id": "fhir-migration-tool"}
    },
    "resources":  [
        {
            "type": "Microsoft.Resources/deployments",
            "apiVersion": "2022-09-01",
            "name": "coreDeploy",
            "properties": {
            "mode": "Incremental",
            "templateLink": {
                "relativePath": "core.json"
            },
            "parameters": {
                "prefixName": {
                    "value": "[variables('prefixNameCleanShort')]"
                },
                "apiForFhirName": {
                    "value": "[parameters('apiForFhirName')]"
                },
                "fhirServiceName": {
                    "value": "[parameters('fhirServiceName')]"
                },
                "location": {
                    "value": "[parameters('location')]"
                },
                "appTags": {
                    "value": "[variables('appTags')]"
                }
            }
            }
        },
        {
            "condition": "[greater(length(parameters('newStorageAccount')), 0)]",
            "type": "Microsoft.Storage/storageAccounts",
            "name": "[concat('store', variables('prefixNameCleanShort'))]",
            "apiVersion": "2021-08-01",
            "location": "[parameters('location')]",
            "tags": "[variables('appTags')]",
            "kind": "StorageV2",
            "sku": {
                "name": "Standard_LRS"
            }
        },
        {
            "condition": false,
            "type": "Microsoft.HealthcareApis/services",
            "name": "[parameters('apiForFhirName')]",
            "apiVersion": "2021-11-01",
            "location": "[parameters('location')]",
            "tags": "[variables('appTags')]",
            "kind": "fhir-R4",
            "properties": {
                "cosmosDbConfiguration": {
                "offerThroughput": 99500
                },
                "exportConfiguration": {
                "storageAccountName": "[concat('store', variables('prefixNameCleanShort'))]"
                }
            },
            "dependsOn": [
                "[resourceId('Microsoft.Storage/storageAccounts', concat('store', variables('prefixNameCleanShort')))]"
            ]
        },
        {
            "type": "Microsoft.Storage/storageAccounts/blobServices/containers",
            "apiVersion": "2021-08-01",
            "name": "migration",
            "dependsOn": [
                "[resourceId('Microsoft.Storage/storageAccounts', concat('store', variables('prefixNameCleanShort')))]"
            ]
        }
    ],
    "outputs": {
        "location": {
            "type": "string",
            "value": "[parameters('location')]"
        },
        "Azure_FunctionURL": {
            "type": "string",
            "value": "[reference('coreDeploy').outputs.Azure_FunctionURL.value]"
        }
    }
}