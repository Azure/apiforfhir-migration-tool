{
    "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
    "contentVersion": "1.0.0.0",
    "metadata": {
      "_generator": {
        "name": "bicep",
        "version": "0.15.31.15270",
        "templateHash": "11861629922040246994"
      }
    },
    "parameters": {
      "prefix": {
        "type": "string",
        "defaultValue": "mig",
        "metadata": {
          "description": "Prefix for all resources"
        }
      },
      "fhirServiceName": {
        "type": "string",
        "defaultValue": "wkspcmigtool/fhirservdest",
        "metadata": {
          "description": "Name of the FHIR Service, destination for migration. Format is \"workspace/fhirService\"."
        }
      },
      "apiForFhirName": {
        "type": "string",
        "defaultValue": "gen1migtool",
        "metadata": {
          "description": "Name of the API for FHIR, source for migration."
        }
      },
      "appName": {
        "type": "string",
        "defaultValue": "[format('fnapp{0}', uniqueString(resourceGroup().id))]",
        "metadata": {
          "description": "The name of the function app that you wish to create."
        }
      },
      "storageAccountType": {
        "type": "string",
        "defaultValue": "Standard_LRS",
        "allowedValues": [
          "Standard_LRS",
          "Standard_GRS",
          "Standard_RAGRS"
        ],
        "metadata": {
          "description": "Storage Account type"
        }
      },
      "location": {
        "type": "string",
        "defaultValue": "[resourceGroup().location]",
        "metadata": {
          "description": "Location for all resources."
        }
      },
      "appInsightsLocation": {
        "type": "string",
        "defaultValue": "[resourceGroup().location]",
        "metadata": {
          "description": "Location for Application Insights"
        }
      },
      "loaderRepoBranch": {
        "type": "string",
        "defaultValue": "personal/snarang/v1.2",
        "metadata": {
          "description": "Branch of the FHIR Loader repo for git integration"
        }
      },
      "fhirid": {
        "type": "string",
        "defaultValue": "/subscriptions/a1766500-6fd5-4f5c-8515-607798271014/resourceGroups/migtool-deploy-rg/providers/Microsoft.HealthcareApis/workspaces/wkspcmigtool/fhirservices/fhirservdest",
        "metadata": {
          "description": "FHIR Server ID"
        }
      },
      "apiForFhirid":{
        "type": "string",
        "defaultValue": "/subscriptions/a1766500-6fd5-4f5c-8515-607798271014/resourceGroups/migtool-deploy-rg/providers/Microsoft.HealthcareApis/services/gen1migtool",
        "metadata": {
          "description": "API for FHIR Server id"
        }
      }
    },
    "variables": {
      "functionAppName": "[format('{0}{1}',parameters('prefix'), parameters('appName'))]",
      "appTags": {
        "AppID": "fhir-migration-function"
      },
      "logAnalyticsName": "[format('{0}{1}-la', parameters('prefix'), parameters('appName'))]",
      "hostingPlanName": "[parameters('appName')]",
      "applicationInsightsName": "[parameters('appName')]",
      "storageAccountName": "[format('{0}azfunctions', uniqueString(resourceGroup().id))]",
      "array": "[split(parameters('fhirServiceName'), '/')]",
      "serviceName": "[variables('array')[1]]",
      "workspaceName": "[variables('array')[0]]",
      "loaderRepoUrl": "https://github.com/Azure/apiforfhir-migration-tool",
      "fhirsegments": "[split(parameters('fhirid'), '/')]",
      "apiForfhirsegments": "[split(parameters('apiForFhirid'), '/')]",
      "fhirRg": "[variables('fhirsegments')[4]]",
      "apiForFhirRg": "[variables('apiForfhirsegments')[4]]"
    },
    "resources": [
      {
        "type": "Microsoft.Storage/storageAccounts",
        "apiVersion": "2022-05-01",
        "name": "[variables('storageAccountName')]",
        "location": "[parameters('location')]",
        "tags": "[variables('appTags')]",
        "sku": {
          "name": "[parameters('storageAccountType')]"
        },
        "resources": [
          {
            "type": "tableServices/tables",
            "apiVersion": "2019-06-01",
            "name": "[concat('default/', 'chunk')]",
            "dependsOn": [
              "[variables('storageAccountName')]"
            ]
          },
          {
            "type": "tableServices/tables",
            "apiVersion": "2019-06-01",
            "name": "[concat('default/', 'export')]",
            "dependsOn": [
              "[variables('storageAccountName')]"
            ]
          }
        ],
        "kind": "Storage",
        "properties": {
          "supportsHttpsTrafficOnly": true,
          "defaultToOAuthAuthentication": true
        }
      },
      {
        "type": "Microsoft.Web/serverfarms",
        "apiVersion": "2021-03-01",
        "name": "[variables('hostingPlanName')]",
        "location": "[parameters('location')]",
        "sku": {
          "name": "S1",
          "tier": "Standard"
        },
        "properties": {}
      },
      {
        "type": "Microsoft.Web/sites",
        "apiVersion": "2021-03-01",
        "name": "[variables('functionAppName')]",
        "location": "[parameters('location')]",
        "kind": "functionapp",
        "tags": "[variables('appTags')]",
        "identity": {
          "type": "SystemAssigned"
        },
        "properties": {
          "serverFarmId": "[resourceId('Microsoft.Web/serverfarms', variables('hostingPlanName'))]",
          "httpsOnly": true,
          "siteConfig": {
            "alwaysOn": true
          }
        },
        "dependsOn": [
          "[resourceId('Microsoft.Insights/components', variables('applicationInsightsName'))]",
          "[resourceId('Microsoft.Web/serverfarms', variables('hostingPlanName'))]",
          "[resourceId('Microsoft.Storage/storageAccounts', variables('storageAccountName'))]"
        ]
      },
      {
        "type": "Microsoft.Web/sites/config",
        "apiVersion": "2020-12-01",
        "name": "[format('{0}/{1}', variables('functionAppName'), 'appsettings')]",
        "location": "[parameters('location')]",
        "properties": {
          "AzureWebJobsStorage": "[format('DefaultEndpointsProtocol=https;AccountName={0};EndpointSuffix={1};AccountKey={2}', variables('storageAccountName'), environment().suffixes.storage, listKeys(resourceId('Microsoft.Storage/storageAccounts', variables('storageAccountName')), '2021-08-01').keys[0].value)]", 
          "FUNCTIONS_EXTENSION_VERSION": "~4",
          "FUNCTIONS_WORKER_RUNTIME": "dotnet-isolated",
          "APPINSIGHTS_INSTRUMENTATIONKEY": "[reference(resourceId('Microsoft.Insights/components', variables('applicationInsightsName')), '2020-02-02').InstrumentationKey]",
          "APPLICATIONINSIGHTS_CONNECTION_STRING": "[reference(resourceId('Microsoft.Insights/components', variables('applicationInsightsName')), '2020-02-02').ConnectionString]",
          "WEBSITE_RUN_FROM_PACKAGE": "1",
          "AZURE_AppInsightConnectionstring": "[reference(resourceId('Microsoft.Insights/components', variables('applicationInsightsName')), '2020-02-02').ConnectionString]",
          "AZURE_DestinationUri": "[format('https://{0}.fhir.azurehealthcareapis.com', replace(parameters('fhirServiceName'), '/', '-'))]", 
          "AZURE_SourceUri": "[format('https://{0}.azurehealthcareapis.com', parameters('apiForFhirName'))]",
          "AZURE_ScheduleInterval": "2",
          "AZURE_ImportMode": "IncrementalLoad",
          "AZURE_DeepCheckCount": "1",
          "AZURE_UserAgent": "FhirMigrationTool",
          "AZURE_SourceHttpClient": "SourceFhirEndpoint", 
          "AZURE_DestinationHttpClient": "DestinationFhirEndpoint",
          "AZURE_ExportTableName": "export",
          "AZURE_ChunkTableName": "chunk", 
          "AZURE_ExportChunkTime": "30",
          "AZURE_stagingStorageAccountName": "[variables('storageAccountName')]",
          "AZURE_StagingStorageUri": "[format('https://{0}.table.core.windows.net', variables('storageAccountName'))]"
          },
        "dependsOn": [
          "[resourceId('Microsoft.Insights/components', variables('applicationInsightsName'))]",
          "[resourceId('Microsoft.Storage/storageAccounts', variables('storageAccountName'))]",
          "[resourceId('Microsoft.Web/sites', variables('functionAppName'))]"
        ]
      },
      // {
      //     "type": "Microsoft.Web/sites/sourcecontrols",
      //     "apiVersion": "2022-03-01",
      //     "name": "[format('{0}/{1}', format('{0}', variables('functionAppName')), 'web')]",
      //     "properties": {
      //       "repoUrl": "[variables('loaderRepoUrl')]",
      //       "branch": "[parameters('loaderRepoBranch')]",
      //       "isManualIntegration": true
      //     },
      //     "dependsOn": [
      //       "[resourceId('Microsoft.Web/sites', variables('functionAppName'))]"
      //     ],
      //     "metadata": {
      //       "description": "Git integration for the function app code"
      //     }
      // },
      {
        "type": "Microsoft.Web/sites/extensions",
        "apiVersion": "2022-03-01",
        "name": "[format('{0}/{1}', variables('functionAppName'), 'zipdeploy')]",
        "properties": {
          "packageUri": "https://github.com/Azure/apiforfhir-migration-tool/tree/personal/snarang/v1.2/zip/ApiForFhirMigrationTool.Function - 20230828141130196.zip"
        },
        "dependsOn": [
          "[resourceId('Microsoft.Web/sites', variables('functionAppName'))]"
        ]
      },
      {
        "type": "Microsoft.Insights/components",
        "apiVersion": "2020-02-02",
        "name": "[variables('applicationInsightsName')]",
        "location": "[parameters('appInsightsLocation')]",
        "kind": "web",
        "properties": {
          "Application_Type": "web",
          "Request_Source": "rest"
        }
      },
      {
          "type": "Microsoft.Resources/deployments",
          "apiVersion": "2022-09-01",
          "name": "migration-function-fhir-managed-id-role-assignment",
          "resourceGroup": "[variables('fhirRg')]",
          "properties": {
              "expressionEvaluationOptions": {
                  "scope": "inner"
              },
              "mode": "Incremental",
              "parameters": {
                  "resourceId": {
                      "value": "[resourceId('Microsoft.HealthcareApis/services', parameters('apiForFhirName'))]"
                  },
                  "roleId": {
                      "value": "5a1fc7df-4bf1-4951-a576-89034ee01acd"
                  },
                  "principalId": {
                      "value": "[reference(resourceId('Microsoft.Web/sites', variables('functionAppName')), '2021-03-01', 'full').identity.principalId]"
                  },
                  "apiForFhirName": {
                      "value": "[parameters('apiForFhirName')]"
                  }
              },
              "template": {
                  "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
                  "contentVersion": "1.0.0.0",
                  "metadata": {
                      "_generator": {
                          "name": "bicep",
                          "version": "0.16.2.56959",
                          "templateHash": "15312434787615452365"
                      }
                  },
                  "parameters": {
                      "resourceId": {
                          "type": "string"
                      },
                      "roleId": {
                          "type": "string"
                      },
                      "principalId": {
                          "type": "string"
                      },
                      "principalType": {
                          "type": "string",
                          "defaultValue": "ServicePrincipal"
                      },
                      "apiForFhirName": {
                            "type": "string"
                      }
                  },
                  "resources": [
                      {
                          "type": "Microsoft.Authorization/roleAssignments",
                          "apiVersion": "2022-04-01",
                          "name": "[guid(parameters('resourceId'), parameters('principalId'), subscriptionResourceId('Microsoft.Authorization/roleDefinitions', parameters('roleId')))]",
                          "scope": "[concat('Microsoft.HealthcareApis/services', '/', parameters('apiForFhirName'))]",
                          "properties": {
                              "roleDefinitionId": "[subscriptionResourceId('Microsoft.Authorization/roleDefinitions', '5a1fc7df-4bf1-4951-a576-89034ee01acd')]",
                              "principalId": "[parameters('principalId')]"
                          }
                      }
                  ]
              }
          },
          "dependsOn": [
              "[resourceId('Microsoft.Web/sites', variables('functionAppName'))]"
          ],
          "metadata": {
              "description": "Setup access between FHIR and the deployment script managed identity"
          }
      },
      {
        "type": "Microsoft.Resources/deployments",
        "apiVersion": "2022-09-01",
        "name": "functionFhirServiceRoleAssignment",
        "resourceGroup": "[variables('apiForFhirRg')]",
        "properties": {
            "expressionEvaluationOptions": {
                "scope": "inner"
            },
            "mode": "Incremental",
            "parameters": {
                // "resourceId": {
                //     "value": "[resourceId('Microsoft.HealthcareApis/workspaces/fhirservices', variables('workspaceName'), variables('serviceName'))]"
                // },
                "roleId": {
                    "value": "5a1fc7df-4bf1-4951-a576-89034ee01acd"
                },
                "principalId": {
                    "value": "[reference(resourceId('Microsoft.Web/sites', variables('functionAppName')), '2021-03-01', 'full').identity.principalId]"
                },
                "workspaceName": {
                    "value": "[variables('workspaceName')]"
                },
                "fhirname": {
                  "value": "[variables('serviceName')]"
                }
            },
            "template": {
                "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
                "contentVersion": "1.0.0.0",
                "metadata": {
                    "_generator": {
                    "name": "bicep",
                    "version": "0.16.2.56959",
                    "templateHash": "15312434787615452365"
                    }
                },
                "parameters": {
                    // "resourceId": {
                    // "type": "string"
                    // },
                    "roleId": {
                        "type": "string"
                    },
                    "principalId": {
                        "type": "string"
                    },
                    "principalType": {
                        "type": "string",
                        "defaultValue": "ServicePrincipal"
                    },
                    "workspaceName": {
                        "type": "string"
                    },
                    "fhirname": {
                        "type": "string"
                    }
                },
                "resources": [
                    {
                        "type": "Microsoft.Authorization/roleAssignments",
                        "apiVersion": "2022-04-01",
                        "name": "[guid(parameters('principalId'), subscriptionResourceId('Microsoft.Authorization/roleDefinitions', parameters('roleId')))]",
                        "scope": "[concat('Microsoft.HealthcareApis/workspaces', '/', parameters('workspaceName'), '/','fhirservices','/' , parameters('fhirname'))]",
                        "properties": {
                            "roleDefinitionId": "[subscriptionResourceId('Microsoft.Authorization/roleDefinitions', '5a1fc7df-4bf1-4951-a576-89034ee01acd')]",
                            "principalId": "[parameters('principalId')]"
                        }
                    }
                ]
            }
        },
        "dependsOn": [
            "[resourceId('Microsoft.Web/sites', variables('functionAppName'))]"
        ],
        "metadata": {
            "description": "Setup access between FHIR and the deployment script managed identity"
        }
      }
    ]
  }